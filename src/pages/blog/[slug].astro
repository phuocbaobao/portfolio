---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { readdirSync, readFileSync } from 'fs';
import { join } from 'path';

export async function getStaticPaths() {
  const blogDir = join(process.cwd(), 'src', 'content', 'blog');
  const files = readdirSync(blogDir).filter(file => file.endsWith('.md'));
  
  return files.map((filename) => {
    const slug = filename.replace('.md', '');
    const content = readFileSync(join(blogDir, filename), 'utf-8');
    
    // Extract frontmatter
    const frontmatterMatch = content.match(/^---\n([\s\S]*?)\n---/);
    const frontmatter: Record<string, any> = {};
    
    if (frontmatterMatch) {
      const frontmatterText = frontmatterMatch[1];
      frontmatterText.split('\n').forEach(line => {
        const match = line.match(/^(\w+):\s*(.+)$/);
        if (match) {
          const key = match[1];
          let value: any = match[2];
          
          // Handle quoted strings
          if (value.startsWith('"') && value.endsWith('"')) {
            value = value.slice(1, -1);
          }
          
          // Handle arrays (tags)
          if (value.startsWith('[') && value.endsWith(']')) {
            value = value.slice(1, -1).split(',').map((v: string) => v.trim().replace(/"/g, ''));
          }
          
          frontmatter[key] = value;
        }
      });
    }
    
    const post = {
      slug,
      title: frontmatter.title || 'Untitled',
      date: frontmatter.date || new Date().toISOString().split('T')[0],
      description: frontmatter.description || '',
      tags: frontmatter.tags || [],
      author: frontmatter.author || 'Anonymous',
      readTime: frontmatter.readTime || '5 min read'
    };
    
    return {
      params: { slug },
      props: { post }
    };
  });
}

const { post } = Astro.props;

// Read markdown content
let content = '';
try {
  const markdownPath = join(process.cwd(), 'src', 'content', 'blog', `${post.slug}.md`);
  const fileContent = readFileSync(markdownPath, 'utf-8');
  
  // Remove frontmatter
  const contentWithoutFrontmatter = fileContent.replace(/^---[\s\S]*?---/, '').trim();
  content = contentWithoutFrontmatter;
} catch (error) {
  console.error('Error reading markdown file:', error);
  content = '# Content not found\n\nThe blog post content could not be loaded.';
}

// Simple markdown to HTML converter (basic implementation)
function markdownToHtml(markdown: string): string {
  let html = markdown;
  
  // Headers
  html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
  html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
  html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');
  
  // Bold
  html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
  
  // Italic
  html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
  
  // Code blocks
  html = html.replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre><code class="language-$1">$2</code></pre>');
  
  // Inline code
  html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
  
  // Links
  html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>');
  
  // Lists
  html = html.replace(/^\- (.*$)/gim, '<li>$1</li>');
  html = html.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
  
  // Paragraphs
  html = html.split('\n\n').map(para => {
    if (!para.startsWith('<') && para.trim()) {
      return `<p>${para}</p>`;
    }
    return para;
  }).join('\n');
  
  return html;
}

const htmlContent = markdownToHtml(content);
---

<BaseLayout title={post.title} description={post.description}>
  <article class="blog-post">
    <!-- Header -->
    <header class="post-header">
      <div class="container">
        <div class="post-meta">
          <time datetime={post.date}>{new Date(post.date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</time>
          <span class="separator">â€¢</span>
          <span>{post.readTime}</span>
        </div>
        <h1 class="post-title">{post.title}</h1>
        <p class="post-description">{post.description}</p>
        <div class="post-tags">
          {post.tags.map((tag: string) => (
            <span class="tag">{tag}</span>
          ))}
        </div>
        <div class="post-author">
          <span>By {post.author}</span>
        </div>
      </div>
    </header>
    
    <!-- Content -->
    <div class="post-content">
      <div class="container">
        <div class="content-wrapper" set:html={htmlContent} />
      </div>
    </div>
    
    <!-- Back to Blog -->
    <div class="post-footer">
      <div class="container">
        <a href="/blog" class="back-link">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M15 10H5M5 10L10 15M5 10L10 5"/>
          </svg>
          Back to Blog
        </a>
      </div>
    </div>
  </article>
</BaseLayout>

<style>
  .blog-post {
    min-height: 100vh;
  }
  
  .post-header {
    background: var(--gradient-primary);
    padding: var(--spacing-3xl) 0 var(--spacing-2xl);
    text-align: center;
  }
  
  .post-meta {
    color: rgba(255, 255, 255, 0.9);
    font-size: var(--text-sm);
    margin-bottom: var(--spacing-md);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-sm);
  }
  
  .separator {
    opacity: 0.5;
  }
  
  .post-title {
    font-size: var(--text-5xl);
    color: white;
    margin-bottom: var(--spacing-md);
    max-width: 800px;
    margin-left: auto;
    margin-right: auto;
  }
  
  .post-description {
    font-size: var(--text-xl);
    color: rgba(255, 255, 255, 0.9);
    max-width: 700px;
    margin: 0 auto var(--spacing-lg);
  }
  
  .post-tags {
    display: flex;
    gap: var(--spacing-sm);
    justify-content: center;
    flex-wrap: wrap;
    margin-bottom: var(--spacing-md);
  }
  
  .post-tags .tag {
    background: rgba(255, 255, 255, 0.2);
    color: white;
    padding: var(--spacing-xs) var(--spacing-md);
    border-radius: var(--radius-full);
    font-size: var(--text-sm);
    font-weight: 500;
  }
  
  .post-author {
    color: rgba(255, 255, 255, 0.8);
    font-size: var(--text-base);
  }
  
  .post-content {
    background: var(--color-bg);
    padding: var(--spacing-3xl) 0;
  }
  
  .content-wrapper {
    max-width: 720px;
    margin: 0 auto;
    font-size: var(--text-lg);
    line-height: 1.8;
    color: var(--color-text-secondary);
  }
  
  /* Typography styles for markdown content */
  .content-wrapper :global(h1) {
    font-size: var(--text-4xl);
    color: var(--color-text);
    margin-top: var(--spacing-2xl);
    margin-bottom: var(--spacing-lg);
  }
  
  .content-wrapper :global(h2) {
    font-size: var(--text-3xl);
    color: var(--color-text);
    margin-top: var(--spacing-2xl);
    margin-bottom: var(--spacing-md);
  }
  
  .content-wrapper :global(h3) {
    font-size: var(--text-2xl);
    color: var(--color-text);
    margin-top: var(--spacing-xl);
    margin-bottom: var(--spacing-md);
  }
  
  .content-wrapper :global(p) {
    margin-bottom: var(--spacing-lg);
  }
  
  .content-wrapper :global(ul),
  .content-wrapper :global(ol) {
    margin-bottom: var(--spacing-lg);
    padding-left: var(--spacing-xl);
  }
  
  .content-wrapper :global(li) {
    margin-bottom: var(--spacing-sm);
  }
  
  .content-wrapper :global(code) {
    background: var(--color-bg-tertiary);
    padding: 0.2em 0.4em;
    border-radius: var(--radius-sm);
    font-family: var(--font-mono);
    font-size: 0.9em;
    color: var(--color-primary);
  }
  
  .content-wrapper :global(pre) {
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--spacing-lg);
    overflow-x: auto;
    margin-bottom: var(--spacing-lg);
  }
  
  .content-wrapper :global(pre code) {
    background: none;
    padding: 0;
    color: var(--color-text);
    font-size: var(--text-sm);
  }
  
  .content-wrapper :global(a) {
    color: var(--color-primary);
    text-decoration: underline;
  }
  
  .content-wrapper :global(a:hover) {
    color: var(--color-secondary);
  }
  
  .content-wrapper :global(strong) {
    color: var(--color-text);
    font-weight: 700;
  }
  
  .content-wrapper :global(blockquote) {
    border-left: 4px solid var(--color-primary);
    padding-left: var(--spacing-lg);
    margin: var(--spacing-lg) 0;
    font-style: italic;
    color: var(--color-text-muted);
  }
  
  .post-footer {
    background: var(--color-bg-secondary);
    padding: var(--spacing-2xl) 0;
    border-top: 1px solid var(--color-border);
  }
  
  .back-link {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-sm);
    color: var(--color-text-secondary);
    font-weight: 500;
    transition: all var(--transition-base);
  }
  
  .back-link:hover {
    color: var(--color-primary);
    transform: translateX(-5px);
  }
  
  @media (max-width: 768px) {
    .post-title {
      font-size: var(--text-3xl);
    }
    
    .post-description {
      font-size: var(--text-lg);
    }
    
    .content-wrapper {
      font-size: var(--text-base);
    }
  }
</style>
